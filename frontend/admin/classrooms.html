<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Manage Classrooms</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/variables.css">
    <link rel="stylesheet" href="../assets/css/global.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <main class="main-content fade-in-up">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold text-primary m-0">Classrooms</h2>
            <button class="btn btn-primary-glass" onclick="openAddModal()">
                <i data-lucide="plus-circle"></i> Add Classroom
            </button>
        </div>

        <div class="glass-card">
            <table class="table align-middle mb-0" style="background:transparent">
                <thead class="text-secondary small text-uppercase">
                    <tr>
                        <th class="ps-4 border-0">Code</th>
                        <th class="border-0">Name</th>
                        <th class="border-0">Department</th>
                        <th class="text-end pe-4 border-0">Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="4" class="text-center py-4">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Add Classroom Modal -->
    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 p-4" style="border-radius:24px;">
                <h5 class="fw-bold mb-3">Add New Classroom</h5>
                <form id="addForm">
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">Classroom Code</label>
                        <input type="text" id="code" class="form-control" placeholder="e.g. CS-101" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">Classroom Name</label>
                        <input type="text" id="name" class="form-control" placeholder="e.g. Lab 1" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-secondary">Department</label>
                        <input type="text" id="dept" class="form-control" placeholder="e.g. CSE" required>
                    </div>
                    <button type="submit" class="btn btn-primary-glass w-100">Create Classroom</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Classroom Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 p-4" style="border-radius:24px;">
                <h5 class="fw-bold mb-3">Edit Classroom</h5>
                <form id="editForm">
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">Classroom Code</label>
                        <input type="text" id="editCode" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">Classroom Name</label>
                        <input type="text" id="editName" class="form-control" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-secondary">Department</label>
                        <input type="text" id="editDept" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary-glass w-100">Update Classroom</button>
                </form>
            </div>
        </div>
    </div>

    <script src="../shared/config.js"></script>
    <script src="../shared/api.js"></script>
    <script src="../shared/auth.js"></script>
    <script src="../shared/admin-layout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let modal;
        let editModal;
        let currentClassroomId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (!Auth.checkAuth('ROLE_ADMIN')) return;

            modal = new bootstrap.Modal(document.getElementById('addModal'));
            editModal = new bootstrap.Modal(document.getElementById('editModal'));
            loadClassrooms();

            document.getElementById('addForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await createClassroom();
            });

            document.getElementById('editForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await updateClassroom();
            });
        });

        async function loadClassrooms() {
            try {
                const data = await api.get('/admin/classrooms');
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';
                if (data && data.length > 0) {
                    data.forEach(item => {
                        // DTO: { id, classroomCode, classroomName, department }
                        tbody.innerHTML += `
                            <tr>
                                <td class="ps-4 fw-bold text-primary">${item.classroomCode}</td>
                                <td class="fw-bold">${item.classroomName}</td>
                                <td>${item.department}</td>
                                <td class="text-end pe-4">
                                    <button onclick="editClassroom(${item.id}, '${item.classroomCode}', '${item.classroomName}', '${item.department}')" class="btn btn-sm btn-light text-primary me-2">
                                        <i data-lucide="edit-2" style="width:16px"></i>
                                    </button>
                                    <button onclick="deleteClassroom(${item.id})" class="btn btn-sm btn-light text-danger">
                                        <i data-lucide="trash-2" style="width:16px"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    lucide.createIcons();
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">No classrooms found.</td></tr>';
                }
            } catch (e) { console.error(e); }
        }

        async function createClassroom() {
            const classroomCode = document.getElementById('code').value;
            const classroomName = document.getElementById('name').value;
            const department = document.getElementById('dept').value;

            const payload = { classroomCode, classroomName, department };

            try {
                await api.post('/admin/classrooms', payload);
                modal.hide();
                document.getElementById('addForm').reset();
                loadClassrooms();
            } catch (e) {
                alert('Failed to create classroom: ' + e.message);
            }
        }

        function editClassroom(id, code, name, dept) {
            currentClassroomId = id;
            document.getElementById('editCode').value = code;
            document.getElementById('editName').value = name;
            document.getElementById('editDept').value = dept;
            editModal.show();
        }

        async function updateClassroom() {
            const classroomCode = document.getElementById('editCode').value;
            const classroomName = document.getElementById('editName').value;
            const department = document.getElementById('editDept').value;

            const payload = {
                classroomCode,
                classroomName,
                department
            };

            try {
                await api.put(`/admin/classrooms/${currentClassroomId}`, payload);
                editModal.hide();
                loadClassrooms();
            } catch (e) {
                alert('Failed to update classroom: ' + e.message);
            }
        }

        async function deleteClassroom(id) {
            if (!confirm('Are you sure?')) return;
            try {
                await api.delete(`/admin/classrooms/${id}`);
                loadClassrooms();
            } catch (e) {
                alert('Failed to delete: ' + e.message);
            }
        }

        window.openAddModal = () => modal.show();
    </script>
</body>

</html>
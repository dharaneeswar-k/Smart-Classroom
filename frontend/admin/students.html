<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Manage Students</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/variables.css">
    <link rel="stylesheet" href="../assets/css/global.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <main class="main-content fade-in-up">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold text-primary m-0">Students</h2>
            <button class="btn btn-primary-glass" onclick="openAddModal()">
                <i data-lucide="user-plus"></i> Add Student
            </button>
        </div>

        <div class="glass-card">
            <table class="table align-middle mb-0" style="background:transparent">
                <thead class="text-secondary small text-uppercase">
                    <tr>
                        <th class="ps-4 border-0">Roll No</th>
                        <th class="border-0">Name</th>
                        <th class="border-0">Classroom</th>
                        <th class="text-end pe-4 border-0">Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="4" class="text-center py-4">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 p-4" style="border-radius:24px;">
                <h5 class="fw-bold mb-3">Add New Student</h5>
                <form id="addForm">
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">Roll Number</label>
                        <input type="text" id="rollNo" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">Full Name</label>
                        <input type="text" id="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">Password</label>
                        <input type="password" id="password" class="form-control" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-secondary">Classroom</label>
                        <select id="classroomSelect" class="form-select">
                            <option value="">Select Classroom...</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-secondary">Face Image (Optional)</label>
                        <input type="file" id="faceImage" class="form-control" accept="image/*">
                        <div class="form-text">Upload a clear face image for AI recognition.</div>
                    </div>
                    <button type="submit" class="btn btn-primary-glass w-100">Create Student</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 p-4" style="border-radius:24px;">
                <h5 class="fw-bold mb-3">Edit Student</h5>
                <form id="editForm">
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">Full Name</label>
                        <input type="text" id="editName" class="form-control" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-secondary">Classroom</label>
                        <select id="editClassroomSelect" class="form-select">
                            <option value="">Select Classroom...</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary-glass w-100">Update Student</button>
                </form>
            </div>
        </div>
    </div>

    <script src="../shared/config.js"></script>
    <script src="../shared/api.js"></script>
    <script src="../shared/auth.js"></script>
    <script src="../shared/admin-layout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let modal;
        let editModal;
        let classroomsMap = {};
        let currentStudentId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (!Auth.checkAuth('ROLE_ADMIN')) return;

            modal = new bootstrap.Modal(document.getElementById('addModal'));
            editModal = new bootstrap.Modal(document.getElementById('editModal'));
            await loadClassrooms(); // Load Classrooms FIRST to build map
            await loadStudents();

            document.getElementById('addForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await createStudent();
            });

            document.getElementById('editForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await updateStudent();
            });
        });

        async function loadClassrooms() {
            try {
                const data = await api.get('/admin/classrooms');
                const sel = document.getElementById('classroomSelect');
                const editSel = document.getElementById('editClassroomSelect');
                const options = '<option value="">Select Classroom...</option>' +
                    (data ? data.map(c => {
                        classroomsMap[c.id] = c.classroomName;
                        return `<option value="${c.id}">${c.classroomName}</option>`;
                    }).join('') : '');

                if (sel) sel.innerHTML = options;
                if (editSel) editSel.innerHTML = options;

            } catch (e) { console.error('Failed to load classrooms', e); }
        }

        async function loadStudents() {
            try {
                const data = await api.get('/admin/students');
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';
                if (data && data.length > 0) {
                    // Sort alphabetically by studentName
                    data.sort((a, b) => (a.studentName || '').localeCompare(b.studentName || ''));

                    data.forEach(item => {
                        const cName = classroomsMap[item.classroomId] || '-';
                        // Escaping to prevent XSS in json strings if we were passing them, but passing ID is safe
                        tbody.innerHTML += `
                            <tr>
                                <td class="ps-4 fw-bold text-primary">${item.studentRollNo || '-'}</td>
                                <td class="fw-bold">${item.studentName || '-'}</td>
                                <td>${cName}</td>
                                <td class="text-end pe-4">
                                    <button onclick="editStudent(${item.id}, '${item.studentName || ''}', ${item.classroomId})" class="btn btn-sm btn-light text-primary me-2">
                                        <i data-lucide="edit-2" style="width:16px"></i>
                                    </button>
                                    <button onclick="deleteStudent(${item.id})" class="btn btn-sm btn-light text-danger">
                                        <i data-lucide="trash-2" style="width:16px"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    lucide.createIcons();
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">No students found.</td></tr>';
                }
            } catch (e) { console.error(e); }
        }

        async function createStudent() {
            const studentRollNo = document.getElementById('rollNo').value;
            const studentName = document.getElementById('name').value;
            const password = document.getElementById('password').value;
            const classroomId = document.getElementById('classroomSelect').value;
            const faceImageInput = document.getElementById('faceImage');

            // DTO Shape: { studentRollNo, studentName, password, classroomId }
            const payload = {
                studentRollNo,
                studentName,
                password
            };
            if (classroomId) payload.classroomId = parseInt(classroomId);

            const formData = new FormData();
            formData.append('student', JSON.stringify(payload));

            if (faceImageInput.files.length > 0) {
                formData.append('image', faceImageInput.files[0]);
            }

            try {
                await api.upload('/admin/students', formData);
                modal.hide();
                document.getElementById('addForm').reset();
                loadStudents();
            } catch (e) {
                alert('Failed to create student: ' + e.message);
            }
        }

        function editStudent(id, name, classroomId) {
            currentStudentId = id;
            document.getElementById('editName').value = name;
            document.getElementById('editClassroomSelect').value = classroomId || "";
            editModal.show();
        }

        async function updateStudent() {
            const studentName = document.getElementById('editName').value;
            const classroomId = document.getElementById('editClassroomSelect').value;

            const payload = {
                studentName,
                classroomId: classroomId ? parseInt(classroomId) : null
            };

            try {
                await api.put(`/admin/students/${currentStudentId}`, payload);
                editModal.hide();
                loadStudents();
            } catch (e) {
                alert('Failed to update student: ' + e.message);
            }
        }

        async function deleteStudent(id) {
            if (!confirm('Are you sure?')) return;
            try {
                await api.delete(`/admin/students/${id}`);
                loadStudents();
            } catch (e) {
                alert('Failed to delete: ' + e.message);
            }
        }

        window.openAddModal = () => modal.show();
    </script>
</body>

</html>
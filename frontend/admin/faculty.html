<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Manage Faculty</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/variables.css">
    <link rel="stylesheet" href="../assets/css/global.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <main class="main-content fade-in-up">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold text-primary m-0">Faculty</h2>
            <button class="btn btn-primary-glass" onclick="openAddModal()">
                <i data-lucide="user-plus"></i> Add Faculty
            </button>
        </div>

        <div class="glass-card">
            <table class="table align-middle mb-0" style="background:transparent">
                <thead class="text-secondary small text-uppercase">
                    <tr>
                        <th class="ps-4 border-0">ID</th>
                        <th class="border-0">Name</th>
                        <th class="border-0">Username/ID</th>
                        <th class="border-0">Designation</th>
                        <th class="text-end pe-4 border-0">Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="5" class="text-center py-4">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Add Faculty Modal -->
    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 p-4" style="border-radius:24px;">
                <h5 class="fw-bold mb-3">Add New Faculty</h5>
                <form id="addForm">
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label small fw-bold text-secondary">First Name</label>
                            <input type="text" id="fName" class="form-control" required>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label small fw-bold text-secondary">Last Name</label>
                            <input type="text" id="lName" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">Designation</label>
                        <input type="text" id="designation" class="form-control" placeholder="e.g. Professor">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">Email (Optional)</label>
                        <input type="email" id="email" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">Username (Employee ID)</label>
                        <input type="text" id="username" class="form-control" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-secondary">Password</label>
                        <input type="password" id="password" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary-glass w-100">Create Faculty</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Faculty Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 p-4" style="border-radius:24px;">
                <h5 class="fw-bold mb-3">Edit Faculty</h5>
                <form id="editForm">
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">Full Name</label>
                        <input type="text" id="editName" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">Designation</label>
                        <input type="text" id="editDesignation" class="form-control" placeholder="e.g. Professor">
                    </div>
                    <button type="submit" class="btn btn-primary-glass w-100">Update Faculty</button>
                </form>
            </div>
        </div>
    </div>

    <script src="../shared/config.js"></script>
    <script src="../shared/api.js"></script>
    <script src="../shared/auth.js"></script>
    <script src="../shared/admin-layout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let modal;
        let editModal;
        let currentFacultyId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (!Auth.checkAuth('ROLE_ADMIN')) return;

            modal = new bootstrap.Modal(document.getElementById('addModal'));
            editModal = new bootstrap.Modal(document.getElementById('editModal'));
            loadFaculty();

            document.getElementById('addForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await createFaculty();
            });

            document.getElementById('editForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await updateFaculty();
            });
        });

        async function loadFaculty() {
            try {
                const data = await api.get('/admin/faculty');
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';
                if (data && data.length > 0) {
                    // Sort alphabetically by facultyName
                    data.sort((a, b) => (a.facultyName || '').localeCompare(b.facultyName || ''));

                    data.forEach(item => {
                        // DTO: { id, facultyName, employeeId, designation ... }
                        tbody.innerHTML += `
                            <tr>
                                <td class="ps-4 text-secondary">#${item.id}</td>
                                <td class="fw-bold text-primary">${item.facultyName}</td>
                                <td>${item.employeeId}</td>
                                <td>${item.designation || '-'}</td>
                                <td class="text-end pe-4">
                                    <button onclick="editFaculty(${item.id}, '${item.facultyName || ''}', '${item.designation || ''}')" class="btn btn-sm btn-light text-primary me-2">
                                        <i data-lucide="edit-2" style="width:16px"></i>
                                    </button>
                                    <button onclick="deleteFaculty(${item.id})" class="btn btn-sm btn-light text-danger">
                                        <i data-lucide="trash-2" style="width:16px"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    lucide.createIcons();
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No faculty found.</td></tr>';
                }
            } catch (e) { console.error(e); }
        }

        async function createFaculty() {
            const firstName = document.getElementById('fName').value;
            const lastName = document.getElementById('lName').value;
            const email = document.getElementById('email').value;
            const employeeId = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const designation = document.getElementById('designation').value;

            const facultyName = `${firstName} ${lastName}`.trim();

            const payload = {
                facultyName,
                employeeId,
                email, // Passed for user provisioning
                password,
                designation
            };

            try {
                await api.post('/admin/faculty', payload);
                modal.hide();
                document.getElementById('addForm').reset();
                loadFaculty();
            } catch (e) {
                alert('Failed to create faculty: ' + e.message);
            }
        }

        function editFaculty(id, name, designation) {
            currentFacultyId = id;
            document.getElementById('editName').value = name;
            document.getElementById('editDesignation').value = designation;
            editModal.show();
        }

        async function updateFaculty() {
            const facultyName = document.getElementById('editName').value;
            const designation = document.getElementById('editDesignation').value;

            const payload = {
                facultyName,
                designation
            };

            try {
                await api.put(`/admin/faculty/${currentFacultyId}`, payload);
                editModal.hide();
                loadFaculty();
            } catch (e) {
                alert('Failed to update faculty: ' + e.message);
            }
        }

        async function deleteFaculty(id) {
            if (!confirm('Delete this faculty member?')) return;
            try {
                await api.delete(`/admin/faculty/${id}`);
                loadFaculty();
            } catch (e) {
                alert('Failed to delete: ' + e.message);
            }
        }

        window.openAddModal = () => modal.show();
    </script>
</body>

</html>